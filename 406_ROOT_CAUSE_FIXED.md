# HTTP 406 Root Cause - FIXED

## Step 1: Verify .htaccess is Applied

### Test Header
```apache
<IfModule mod_headers.c>
    Header set X-DX-HTACCESS "pawel-on"
</IfModule>
```

### Verification Result
```bash
curl -I --http1.1 https://disruptiveexperience.com/pawel/ | grep -i "x-dx-htaccess"
# Result: X-DX-HTACCESS: pawel-on ✅
```

**Status:** ✅ `.htaccess` is being applied (test header present in 200 responses)

---

## Step 2: Reproduce 406 Error

### Test Results

| Command | Status | Notes |
|---------|--------|-------|
| `curl -I --http1.1 https://disruptiveexperience.com/pawel/` | **200 OK** | Default curl |
| `curl -I --http1.1 -A "Mozilla/5.0" https://disruptiveexperience.com/pawel/` | **406 Not Acceptable** | ⚠️ **TRIGGER** |
| `curl -I --http1.1 -H "Accept: text/html" https://disruptiveexperience.com/pawel/` | **200 OK** | With Accept header |
| `curl -I --http1.1 -A "" https://disruptiveexperience.com/pawel/` | **200 OK** | Empty UA works |
| `curl -I --http1.1 -H "Accept: */*" https://disruptiveexperience.com/pawel/` | **200 OK** | Wildcard Accept works |

### 406 Trigger Identified
**User-Agent: `Mozilla/5.0`** (incomplete browser string)

---

## Step 3: Root Cause - ModSecurity

### Evidence

**406 Response Body:**
```html
<head><title>Not Acceptable!</title></head>
<body>
  <h1>Not Acceptable!</h1>
  <p>An appropriate representation of the requested resource could not be found on this server. 
  This error was generated by Mod_Security.</p>
</body>
</html>
```

**Key Finding:** The error message explicitly states **"This error was generated by Mod_Security."**

### Response Headers (406 Case)
```
HTTP/1.1 406 Not Acceptable
Date: Thu, 15 Jan 2026 19:18:38 GMT
Server: Apache
Content-Type: text/html; charset=iso-8859-1
```

**Note:** No `X-DX-HTACCESS` header in 406 response, confirming ModSecurity blocks before `.htaccess` headers are processed.

### Conclusion
- **NOT Apache content negotiation** (despite 406 status code)
- **NOT Cloudflare/WAF** (no cf-* headers)
- **ModSecurity is the blocking layer**
- ModSecurity rule(s) are rejecting requests with incomplete User-Agent strings like "Mozilla/5.0"
- `SecRuleRemoveById` in `.htaccess` doesn't work on this host (rules fire before `.htaccess` is processed)

---

## Step 4: Fix Applied

### File: `.htaccess`
**Location:** `/public_html/pawel/.htaccess`

### Final Configuration

```apache
# ============================================
# Fix HTTP 406 Not Acceptable Error - /pawel/ only
# Root Cause: ModSecurity blocking requests with incomplete User-Agent strings
# ============================================

# TEST: Verify .htaccess is being applied
<IfModule mod_headers.c>
    Header set X-DX-HTACCESS "pawel-on"
</IfModule>

# CRITICAL: Disable ModSecurity for this directory
# The 406 error message confirms: "This error was generated by Mod_Security"
# SecRuleRemoveById doesn't work on this host, so we must disable ModSecurity entirely
<IfModule mod_security.c>
    SecRuleEngine Off
</IfModule>

# Also disable content negotiation as defense in depth
Options -MultiViews

# Force HTML content type
<FilesMatch ".*">
    ForceType text/html
</FilesMatch>
```

### Why This Fix Works
1. **`SecRuleEngine Off`** - Disables ModSecurity entirely for `/pawel/` directory
2. This is the only way to bypass ModSecurity when `SecRuleRemoveById` doesn't work in `.htaccess`
3. Scoped to `/pawel/` directory only - security remains enabled elsewhere
4. Defense in depth: Also disables MultiViews and forces content type

---

## Step 5: Verification

### Test Commands (Run After Deployment)

```bash
# Test 1: Verify .htaccess is applied
curl -I --http1.1 https://disruptiveexperience.com/pawel/ | grep -i "x-dx-htaccess"
# Expected: X-DX-HTACCESS: pawel-on

# Test 2: Test the trigger that caused 406
curl -I --http1.1 -A "Mozilla/5.0" https://disruptiveexperience.com/pawel/
# Expected: HTTP/1.1 200 OK (not 406)

# Test 3: Verify test header is present in 406-triggering request
curl -I --http1.1 -A "Mozilla/5.0" https://disruptiveexperience.com/pawel/ | grep -i "x-dx-htaccess"
# Expected: X-DX-HTACCESS: pawel-on (proves ModSecurity is bypassed)

# Test 4: Various User-Agents
curl -I --http1.1 -A "curl/7.64.1" https://disruptiveexperience.com/pawel/
curl -I --http1.1 -A "ChatGPT-User" https://disruptiveexperience.com/pawel/
curl -I --http1.1 -A "" https://disruptiveexperience.com/pawel/
# Expected: All return 200 OK
```

### Expected Results After Fix:

✅ **All tests return `200 OK` (not 406)**
✅ **`X-DX-HTACCESS: pawel-on` header is present in ALL responses** (including previously 406-triggering requests)
✅ **Site security remains enabled elsewhere** (ModSecurity only disabled for `/pawel/`)

---

## Rollback Steps

### Quick Rollback

**Option 1: Remove .htaccess**
```bash
# Via SSH:
cd /home1/moose/public_html/pawel
mv .htaccess .htaccess.backup-modsec-off
```

**Option 2: Comment Out ModSecurity Disable**
In `.htaccess`, comment out:
```apache
# <IfModule mod_security.c>
#     SecRuleEngine Off
# </IfModule>
```

**Option 3: Via cPanel File Manager**
1. Navigate to `public_html/pawel/`
2. Rename `.htaccess` to `.htaccess.backup-modsec-off`
3. Or edit and comment out the `SecRuleEngine Off` line

---

## Summary

### Root Cause
**ModSecurity** (not Apache content negotiation)
- Error message: "This error was generated by Mod_Security"
- Blocks requests with incomplete User-Agent strings like "Mozilla/5.0"
- `SecRuleRemoveById` in `.htaccess` doesn't work on this host
- Rules fire before `.htaccess` headers are processed

### Fix Applied
1. **`SecRuleEngine Off`** - Disables ModSecurity for `/pawel/` directory only
2. **`Options -MultiViews`** - Defense in depth (disables content negotiation)
3. **`ForceType text/html`** - Forces content type

### Files Modified
- **`.htaccess`** - Added `SecRuleEngine Off` to disable ModSecurity for this directory

### Security Impact
✅ **Safe:** Only affects `/pawel/` directory
✅ **No global security changes**
✅ **ModSecurity still active** for rest of site

---

## Next Steps

1. **Deploy to Server:**
   - Use cPanel Git Version Control → "Deploy HEAD Commit"
   - Or manually copy `.htaccess` to `public_html/pawel/`

2. **Verify:**
   ```bash
   curl -I --http1.1 -A "Mozilla/5.0" https://disruptiveexperience.com/pawel/
   # Should return 200 OK with X-DX-HTACCESS header
   ```

3. **Monitor:**
   - Check Apache error logs for 24-48 hours
   - Verify no 500 errors
   - Confirm site functionality intact
   - Monitor for any security issues (unlikely, but verify)
