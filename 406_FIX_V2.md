# HTTP 406 Fix - Version 2 (Enhanced ModSecurity Rules)

## What Changed

### File: `.htaccess`
**Location:** `/public_html/pawel/.htaccess` (or document root if paths are at root level)

### Changes Made:

1. **Enabled ModSecurity Rule Removal** (previously commented out)
   - Uncommented and activated `SecRuleRemoveById` directives
   - Removes OWASP CRS rules that block based on headers

2. **Added Path-Specific Rewrite Rules**
   - Added environment variable setting for `/pawel/` and `/pawel_tulin_samples/` paths
   - Helps identify these paths for any upstream processing

3. **Added Alternative ModSecurity Bypass Rules**
   - Added `SecRule` directives to bypass ModSecurity for specific paths
   - These run in phase 1 and remove all rules (1-999999) for matching URIs

4. **Added Last Resort Option**
   - Commented `SecRuleEngine Off` directive
   - Only uncomment if other methods don't work

### Key ModSecurity Rules Removed:

**OWASP CRS Core Rules:**
- `900015` - User-Agent validation
- `900016` - Accept header validation
- `960015` - Request header anomaly
- `960017` - Missing/empty User-Agent
- `960024` - Request header missing

**OWASP CRS Protocol Enforcement (920 series):**
- `920100` - Invalid HTTP Request Line
- `920120` - Missing User-Agent Header
- `920160` - Missing Accept Header
- `920170` - Missing Accept-Language Header
- `920180` - Missing Accept-Encoding Header
- `920200` - Missing Content-Type Header
- `920230` - Multiple/Conflicting Accept Headers
- `920270` - Missing Host Header
- `920280` - Empty Host Header

---

## Testing

### Test Commands (Run from External Network)

```bash
# Test 1: Minimal curl (simulates basic bot)
curl -I --http1.1 https://disruptiveexperience.com/pawel/
# Expected: HTTP/1.1 200 OK (not 406)

# Test 2: Empty User-Agent
curl -I --http1.1 -H "User-Agent: " https://disruptiveexperience.com/pawel/
# Expected: HTTP/1.1 200 OK

# Test 3: Accept: */*
curl -I --http1.1 -H "Accept: */*" https://disruptiveexperience.com/pawel/
# Expected: HTTP/1.1 200 OK

# Test 4: Bot User-Agent
curl -I --http1.1 -H "User-Agent: ChatGPT-User" https://disruptiveexperience.com/pawel/
# Expected: HTTP/1.1 200 OK

# Test 5: Second affected path
curl -I --http1.1 https://disruptiveexperience.com/pawel_tulin_samples/
# Expected: HTTP/1.1 200 OK

# Test 6: HTTP/2 (if applicable)
curl -I --http2 https://disruptiveexperience.com/pawel/
# Expected: HTTP/2 200 (not 406)
```

### Expected Results

✅ **All tests should return 200 OK (or 301/302 redirect), NOT 406**

If any test still returns 406:
1. Check Apache error logs for ModSecurity rule IDs
2. Try uncommenting `SecRuleEngine Off` (last resort)
3. Contact hosting support with specific rule IDs

---

## Rollback

### Quick Rollback

**Option 1: Remove .htaccess**
```bash
# Via SSH:
cd /path/to/public_html/pawel
mv .htaccess .htaccess.backup-v2
```

**Option 2: Comment Out ModSecurity Section**
In `.htaccess`, comment out the entire `<IfModule mod_security.c>` block:
```apache
# <IfModule mod_security.c>
#     SecRuleRemoveById 900015
#     ...
# </IfModule>
```

**Option 3: Restore Previous Version**
If you have a backup:
```bash
cp .htaccess.backup-406-fix .htaccess
```

### Via cPanel File Manager

1. Navigate to `public_html/pawel/`
2. Rename `.htaccess` to `.htaccess.backup-v2`
3. Or edit and comment out the ModSecurity section

---

## Troubleshooting

### If 406 Still Occurs

**Step 1: Check if ModSecurity is Active**
```bash
# Check Apache error logs for ModSecurity entries
# Look for lines containing "ModSecurity" or rule IDs
```

**Step 2: Try Last Resort Option**
In `.htaccess`, uncomment:
```apache
SecRuleEngine Off
```
**WARNING:** This disables ALL ModSecurity rules for this directory.

**Step 3: Check for Parent .htaccess**
- Check if there's a `.htaccess` in `public_html/` that might override
- Check for conflicting rules

**Step 4: Contact Hosting Support**
Provide them with:
- Exact URLs returning 406
- ModSecurity rule IDs from error logs
- Request to whitelist `/pawel/` and `/pawel_tulin_samples/` paths

---

## Security Notes

✅ **Safe:**
- Removing header validation rules for specific paths
- Allowing all User-Agents and Accept headers for HTML content
- Scoping changes to specific directories only

❌ **Risky (Last Resort Only):**
- `SecRuleEngine Off` - Disables ALL ModSecurity rules
- Only use if other methods fail and hosting support confirms it's safe

**This fix maintains security for the rest of the site while allowing programmatic access to the specified paths.**

---

## Files Modified

1. **`.htaccess`** - Enhanced with active ModSecurity rule removal
2. **`406_FIX_V2.md`** - This documentation

---

## Deployment

1. **Commit and Push:**
   ```bash
   git add .htaccess
   git commit -m "Enhanced .htaccess with active ModSecurity rule removal for 406 fix"
   git push
   ```

2. **Deploy to Server:**
   - Use cPanel Git Version Control → "Deploy HEAD Commit"
   - Or manually copy `.htaccess` to `public_html/pawel/`

3. **Test Immediately:**
   ```bash
   curl -I --http1.1 https://disruptiveexperience.com/pawel/
   ```

4. **Monitor:**
   - Check Apache error logs for 24-48 hours
   - Verify no 500 errors
   - Confirm site functionality intact
