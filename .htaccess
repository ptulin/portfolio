# ============================================
# Fix HTTP 406 Not Acceptable Error
# Scoped to /pawel/ path only
# ============================================
# 
# This configuration addresses 406 errors for non-browser clients
# while maintaining security for the rest of the site.
#
# Root Cause: Content negotiation or WAF rules blocking requests
# with non-standard Accept headers or User-Agents
# ============================================

# TEST: Verify .htaccess is being applied
<IfModule mod_headers.c>
    Header set X-DX-HTACCESS "pawel-on"
</IfModule>

# Disable MultiViews content negotiation (common cause of 406)
<IfModule mod_negotiation.c>
    Options -MultiViews
</IfModule>

# Force HTML content type for .html files (prevents negotiation issues)
<FilesMatch "\.(html|htm)$">
    ForceType text/html
    Header set Content-Type "text/html; charset=utf-8"
</FilesMatch>

# Allow all Accept headers for HTML content
# This ensures bots, AI tools, and API clients can access pages
<IfModule mod_headers.c>
    # Remove Accept header restrictions for HTML pages
    Header unset Accept
    Header append Accept "*/*"
</IfModule>

# ============================================
# Path-Specific Rules - Scope to /pawel/ and /pawel_tulin_samples/
# ============================================
# If .htaccess is in document root, use LocationMatch to scope rules
# If .htaccess is in /pawel/, these rules apply to that directory only
<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # Allow all requests to /pawel/ and /pawel_tulin_samples/ paths
    # This prevents any upstream blocking rules from affecting these paths
    RewriteCond %{REQUEST_URI} ^/pawel(/|$) [OR]
    RewriteCond %{REQUEST_URI} ^/pawel_tulin_samples(/|$)
    RewriteRule .* - [E=ALLOW_REQUEST:1]
</IfModule>

# ============================================
# mod_security Whitelisting - ACTIVE
# ============================================
# Remove ModSecurity rules that cause 406 errors for non-browser clients
# These rules are scoped to this directory only
<IfModule mod_security.c>
    # OWASP CRS rules that block based on headers (common 406 causes)
    SecRuleRemoveById 900015  # User-Agent validation
    SecRuleRemoveById 900016  # Accept header validation
    SecRuleRemoveById 960015  # Request header anomaly
    SecRuleRemoveById 960017  # Missing/empty User-Agent
    SecRuleRemoveById 960024  # Request header missing
    
    # OWASP CRS 920 series - Protocol Enforcement (header validation)
    SecRuleRemoveById 920100  # Invalid HTTP Request Line
    SecRuleRemoveById 920120  # Missing User-Agent Header
    SecRuleRemoveById 920160  # Missing Accept Header
    SecRuleRemoveById 920170  # Missing Accept-Language Header
    SecRuleRemoveById 920180  # Missing Accept-Encoding Header
    SecRuleRemoveById 920200  # Missing Content-Type Header (for POST)
    SecRuleRemoveById 920230  # Multiple/Conflicting Accept Headers
    SecRuleRemoveById 920270  # Missing Host Header
    SecRuleRemoveById 920280  # Empty Host Header
    
    # Alternative: Allow all requests to /pawel/ paths
    # This creates a pass rule that bypasses ModSecurity for these paths
    SecRule REQUEST_URI "@beginsWith /pawel" "id:1000,phase:1,pass,nolog,ctl:ruleRemoveById=1-999999"
    SecRule REQUEST_URI "@beginsWith /pawel_tulin_samples" "id:1001,phase:1,pass,nolog,ctl:ruleRemoveById=1-999999"
    
    # Last resort: Disable ModSecurity entirely for this directory
    # WARNING: Only uncomment if SecRuleRemoveById and SecRule don't work
    # This disables ALL ModSecurity rules for this directory
    # SecRuleEngine Off
</IfModule>

# ============================================
# Security: Block malicious patterns (safe - doesn't affect bots)
# ============================================
<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # Block SQL injection attempts (safe - doesn't affect legitimate bots)
    RewriteCond %{QUERY_STRING} (\<|%3C).*script.*(\>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} GLOBALS(=|\[|\%[0-9A-Z]{0,2}) [OR]
    RewriteCond %{QUERY_STRING} _REQUEST(=|\[|\%[0-9A-Z]{0,2})
    RewriteRule .* - [F,L]
    
    # DO NOT block based on User-Agent
    # DO NOT block based on Accept header
    # These rules would cause 406 errors for legitimate clients
</IfModule>

# ============================================
# IMPORTANT: Remove or comment out any existing rules that:
# - Check HTTP_USER_AGENT and return [F] (Forbidden)
# - Check HTTP:Accept and return [F]
# - Block based on User-Agent or Accept headers
# ============================================
#
# Example of what to REMOVE/COMMENT OUT:
# RewriteCond %{HTTP_USER_AGENT} ^.*(bot|crawler|spider).*$ [NC]
# RewriteRule .* - [F,L]
#
# RewriteCond %{HTTP:Accept} !text/html [NC]
# RewriteRule .* - [F,L]
#
# SetEnvIf User-Agent ".*bot.*" block_ua
# Deny from env=block_ua
